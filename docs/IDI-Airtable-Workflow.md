# IDI to Airtable Smart Linking Workflow

## Overview
This document outlines the complete workflow for transforming IDI skip trace CSV files into normalized Airtable records with intelligent linking between Contacts and Addresses.

## Workflow Architecture

### ðŸ”„ **Complete Workflow Pattern**
```
Dropbox â†’ IDI Format â†’ Filter/Split â†’ AirtablePlus Create â†’ ID Capture â†’ AirtablePlus Update (Link)
```

### ðŸ“Š **Data Flow**
1. **CSV Input**: IDI skip trace file from Dropbox
2. **Transform**: IDI node converts to normalized JSON records
3. **Split**: Separate Contacts and Addresses 
4. **Create**: AirtablePlus creates records and returns IDs
5. **Link**: Use returned IDs to update relationship fields

## IDI Node Configuration

### **Input Options**
- **CSV File (Binary)**: Process files from Dropbox/file uploads
- **JSON Data**: Process pre-parsed data directly

### **Output Options**
- **Contacts Only**: Just contact records
- **Addresses Only**: Just address records  
- **Both**: All records with `_metadata.recordType` to distinguish

### **Features**
- âœ… **Bulk Processing**: Handles entire CSV files at once
- âœ… **Smart Parsing**: Handles quoted CSV fields and commas
- âœ… **Relationship Tracking**: Maintains ID references for linking
- âœ… **Metadata**: Tracks source CSV row and file info

## Smart Linking Strategies

### **Strategy 1: Sequential Create + Update (Recommended)**

#### **Step 1: Create Contacts**
```json
// Workflow: Dropbox â†’ IDI Format â†’ Filter (Contacts) â†’ AirtablePlus Create
{
  "operation": "create",
  "table": "Contacts",
  "data": "{{$json}}" // IDI contact records
}
```

#### **Step 2: Create Addresses** 
```json
// Workflow: IDI Format â†’ Filter (Addresses) â†’ AirtablePlus Create
{
  "operation": "create", 
  "table": "Addresses",
  "data": "{{$json}}" // IDI address records
}
```

#### **Step 3: Link Records**
Use n8n's **Merge** node to combine the created records, then update with relationships:

```json
// Update Contacts with Address IDs
{
  "operation": "update",
  "matchOn": ["Record ID"], 
  "data": {
    "Contact Addresses": ["{{$json.addressRecordId}}"] // From merge
  }
}
```

### **Strategy 2: Upsert with Smart Matching**

#### **Use AirtablePlus Upsert**
```json
{
  "operation": "upsert",
  "matchOn": ["Record ID"], // Use IDI-generated IDs
  "matchingStrategy": "soft", // Flexible matching
  "data": "{{$json}}"
}
```

**Benefits**:
- âœ… Prevents duplicates
- âœ… Updates existing records
- âœ… Handles incremental data loads

### **Strategy 3: Batch Processing with ID Management**

#### **Custom Workflow Node Pattern**
```javascript
// In a Code node - capture and map IDs
const contactIds = new Map();
const addressIds = new Map();

// Process contacts first
for (const contact of contacts) {
  const result = await $('AirtablePlus').create(contact);
  contactIds.set(contact['Record ID'], result.id);
}

// Process addresses with contact links
for (const address of addresses) {
  const linkedContactIds = address['Contacts'].map(contactRecordId => 
    contactIds.get(contactRecordId)
  ).filter(Boolean);
  
  address['Contacts'] = linkedContactIds;
  const result = await $('AirtablePlus').create(address);
  addressIds.set(address['Record ID'], result.id);
}

// Update contacts with address links
for (const [recordId, airtableId] of contactIds) {
  const contact = findContactByRecordId(recordId);
  const linkedAddressIds = contact['Contact Addresses'].map(addressRecordId =>
    addressIds.get(addressRecordId)
  ).filter(Boolean);
  
  await $('AirtablePlus').update({
    id: airtableId,
    'Contact Addresses': linkedAddressIds
  });
}
```

## Field Mapping

### **Contact Record Structure**
```json
{
  "id": "rec...", // Generated by IDI
  "Contact": "john-doe-1", // Display name
  "First Name": "John",
  "Last Name": "Doe", 
  "Full Name": "John Doe",
  "Phone": "(555)123-4567",
  "Email": "john@example.com",
  "Relations": ["rec..."], // Links to other contacts
  "Contact Addresses": ["rec..."], // Links to addresses
  "Record ID": "IDI_CONTACT_001", // IDI tracking ID
  "_metadata": {
    "recordType": "contact",
    "csvRowIndex": 1,
    "originalFileName": "skip_trace_data.csv"
  }
}
```

### **Address Record Structure**
```json
{
  "id": "rec...", // Generated by IDI
  "Address": "123 Main St - Springfield",
  "Street 1": "123 Main St",
  "City": "Springfield", 
  "State": "IL",
  "Zip Code": "62701",
  "Contacts": ["rec..."], // Links to contacts
  "Record ID": "IDI_ADDRESS_001", // IDI tracking ID
  "_metadata": {
    "recordType": "address",
    "csvRowIndex": 1,
    "originalFileName": "skip_trace_data.csv"
  }
}
```

## Best Practices

### **ðŸŽ¯ Workflow Design**
1. **Use Filters**: Split contacts/addresses early for parallel processing
2. **Capture IDs**: Always store returned Airtable IDs for linking
3. **Error Handling**: Use "Continue on Fail" for partial success
4. **Batch Size**: Process in chunks of 10-50 records for reliability

### **ðŸ”— Linking Strategy**
1. **Create First**: Always create records before linking
2. **Use Record IDs**: IDI generates stable IDs for matching
3. **Bidirectional Links**: Update both sides of relationships
4. **Validate Links**: Check that linked records exist

### **ðŸ“ˆ Performance Tips**
1. **Parallel Processing**: Create contacts and addresses simultaneously
2. **Bulk Operations**: Use AirtablePlus batch capabilities
3. **Smart Matching**: Use upsert to avoid duplicates
4. **Incremental Updates**: Only update changed fields

## Example Workflows

### **Simple Workflow**
```
Dropbox â†’ IDI Format â†’ AirtablePlus Create (Both)
```

### **Advanced Workflow**
```
Dropbox â†’ IDI Format â†’ Split â†’ 
  â”œâ”€â”€ Filter (Contacts) â†’ AirtablePlus Create â†’ Store IDs
  â””â”€â”€ Filter (Addresses) â†’ AirtablePlus Create â†’ Store IDs
                                             â†“
Merge IDs â†’ AirtablePlus Update (Link Relationships)
```

### **Production Workflow**
```
Dropbox â†’ IDI Format â†’ 
  â”œâ”€â”€ Filter (Contacts) â†’ AirtablePlus Upsert (Match: Record ID)
  â”œâ”€â”€ Filter (Addresses) â†’ AirtablePlus Upsert (Match: Record ID)  
  â””â”€â”€ Code Node (Smart Linking Logic) â†’ AirtablePlus Update
```

## Troubleshooting

### **Common Issues**
- **Missing IDs**: Ensure AirtablePlus returns record IDs
- **Link Failures**: Check that linked records exist first
- **Duplicate Records**: Use upsert with proper matching fields
- **CSV Parsing**: Verify CSV format and encoding

### **Debugging Tips**
- Use `_metadata` fields to track record sources
- Log intermediate results in Code nodes
- Test with small CSV files first
- Monitor Airtable API rate limits

## Next Steps
1. Test with sample IDI CSV file
2. Configure Airtable base with proper field types
3. Set up initial workflow with error handling
4. Scale to production data volumes 
